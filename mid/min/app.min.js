function Utils(errorOutputId){let self=this;this.errorOutput=document.getElementById(errorOutputId);const OPENCV_URL='./opencv.js';this.loadOpenCv=function(onloadCallback){let script=document.createElement('script');script.setAttribute('async','');script.setAttribute('type','text/javascript');script.addEventListener('load',()=>{console.log(cv.getBuildInformation());onloadCallback()});script.addEventListener('error',()=>{self.printError('Failed to load '+OPENCV_URL)});script.src=OPENCV_URL;let node=document.getElementsByTagName('script')[0];node.parentNode.insertBefore(script,node)};this.createFileFromUrl=function(path,url,callback){let request=new XMLHttpRequest();request.open('GET',url,!0);request.responseType='arraybuffer';request.onload=function(ev){if(request.readyState===4){if(request.status===200){let data=new Uint8Array(request.response);cv.FS_createDataFile('/',path,data,!0,!1,!1);callback()}else{self.printError('Failed to load '+url+' status: '+request.status)}}};request.send()};this.loadImageToCanvas=function(url,cavansId){let canvas=document.getElementById(cavansId);let ctx=canvas.getContext('2d');let img=new Image();img.crossOrigin='anonymous';img.onload=function(){canvas.width=img.width;canvas.height=img.height;ctx.drawImage(img,0,0,img.width,img.height)};img.src=url};this.showImage=function(canvas_id,mat){var data=mat.data;var channels=mat.channels();var channelSize=mat.elemSize1();var canvas=document.getElementById(canvas_id);var ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);canvas.width=mat.cols;canvas.height=mat.rows;var imdata=ctx.createImageData(mat.cols,mat.rows);for(var i=0,j=0;i<data.length;i+=channels,j+=4){imdata.data[j]=data[i];imdata.data[j+1]=data[i+1%channels];imdata.data[j+2]=data[i+2%channels];imdata.data[j+3]=255}
ctx.putImageData(imdata,0,0)}
this.executeCode=function(textAreaId){try{this.clearError();let code=document.getElementById(textAreaId).value;eval(code)}catch(err){this.printError(err)}};this.showError=function(err){var errAlert=document.createElement('div');errAlert.setAttribute('class','alert');var closebtn=document.createElement('span');closebtn.setAttribute('class','closebtn');closebtn.setAttribute('onclick','var div = this.parentElement;div.style.opacity = "0";setTimeout(function(){ div.style.display = "none"; }, 600);');closebtn.innerHTML='&times;';errAlert.appendChild(closebtn);var t=document.createElement('span');t.innerHTML=err;errAlert.appendChild(t);this.errorOutput.appendChild(errAlert)};this.clearError=function(){this.errorOutput.innerHTML=''};this.printError=function(err){if(typeof err==='undefined'){err=''}else if(typeof err==='number'){if(!isNaN(err)){if(typeof cv!=='undefined'){err='Exception: '+cv.exceptionFromPtr(err).msg}}}else if(typeof err==='string'){let ptr=Number(err.split(' ')[0]);if(!isNaN(ptr)){if(typeof cv!=='undefined'){err='Exception: '+cv.exceptionFromPtr(ptr).msg}}}else if(err instanceof Error){err=err.stack.replace(/\n/g,'<br>')}
var n=err.indexOf(":")+1;var e_title=err.substring(0,n);var e=err.substring(n+1);this.showError("<strong>"+e_title+"</strong> "+e)};this.loadCode=function(scriptId,textAreaId){let scriptNode=document.getElementById(scriptId);let textArea=document.getElementById(textAreaId);if(scriptNode.type!=='text/code-snippet'){throw Error('Unknown code snippet type')}
textArea.value=scriptNode.text.replace(/^\n/,'')};this.addFileInputHandler=function(fileInputId,canvasId){let inputElement=document.getElementById(fileInputId);inputElement.addEventListener('change',(e)=>{let files=e.target.files;if(files.length>0){let imgUrl=URL.createObjectURL(files[0]);self.loadImageToCanvas(imgUrl,canvasId)}},!1)};function onVideoCanPlay(){if(self.onCameraStartedCallback){self.onCameraStartedCallback(self.stream,self.video)}};this.startCamera=function(resolution,callback,videoId){const constraints={'qvga':{width:{exact:320},height:{exact:240}},'vga':{width:{exact:640},height:{exact:480}}};let video=document.getElementById(videoId);if(!video){video=document.createElement('video')}
let videoConstraint=constraints[resolution];if(!videoConstraint){videoConstraint=!0}
navigator.mediaDevices.getUserMedia({video:videoConstraint,audio:!1}).then(function(stream){video.srcObject=stream;video.play();self.video=video;self.stream=stream;self.onCameraStartedCallback=callback;video.addEventListener('canplay',onVideoCanPlay,!1)}).catch(function(err){self.printError('Camera Error: '+err.name+' '+err.message)})};this.stopCamera=function(){if(this.video){this.video.pause();this.video.srcObject=null;this.video.removeEventListener('canplay',onVideoCanPlay)}
if(this.stream){this.stream.getVideoTracks()[0].stop()}}};Utils.RangeSliders=function(rangeSlidersId){let self=this;this.rangeSliders=document.getElementById(rangeSlidersId);this.init=function(valueId){var rangeValue=document.getElementById(valueId);rangeValue.innerHTML=this.rangeSliders.value;this.rangeSliders.oninput=function(){rangeValue.innerHTML=this.value}};this.getValue=function(){return parseFloat(this.rangeSliders.value)}};Utils.ProgressBar=function(progressBarId){let self=this;this.progressBarId=progressBarId;this.progressBar=document.getElementById(progressBarId);this.init=function(){this.progressBar.style.width='0%';this.progressBar.innerHTML='0%'};this.runTo=function(end){var progressBar=document.getElementById(this.progressBarId);var id=setInterval(frame,10);var width=parseInt(this.progressBar.style.width);function frame(){if(width>=end||width>=100){clearInterval(id);return!0}else{width++;progressBar.style.width=width+'%';progressBar.innerHTML=width+'%'}}}};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}
Utils.SpeechSyn=function(voiceSelect_id){let self=this;this.voiceSelect_id=voiceSelect_id;this.isSupport=function(){return('speechSynthesis' in window)}
this.clearVoices=function(){document.getElementById(voiceSelect_id).innerHTML=''}
this.loadVoices=function(lang){var isFilter=lang===undefined?!1:!0;var voices=speechSynthesis.getVoices();if(isFilter){voices=speechSynthesis.getVoices().filter(function(voice){return voice.lang.search(lang)!=-1})}
voices.forEach(function(voice,i){var option=document.createElement('option');option.value=voice.name;option.innerHTML=voice.name;var voiceSelect=document.getElementById(voiceSelect_id);voiceSelect.appendChild(option)})}
this.speak=function(text){var voiceSelect=document.getElementById(voiceSelect_id);var msg=new SpeechSynthesisUtterance();msg.text=text;if(voiceSelect.value){msg.voice=speechSynthesis.getVoices().filter(function(voice){return voice.name==voiceSelect.value})[0]}
window.speechSynthesis.speak(msg)}
this.stop=function(){window.speechSynthesis.cancel()}}
function canvasSupport(e){return!!e.getContext}
function CanvasApp(canvas_id){let self=this;var myCanvas=document.getElementById(canvas_id);if(!canvasSupport(myCanvas)){return}
var ctx=myCanvas.getContext('2d');myCanvas.addEventListener('mousedown',mouseDown,!1);myCanvas.addEventListener('mouseup',mouseUp,!1);myCanvas.addEventListener('mousemove',mouseMove,!1);myCanvas.addEventListener('touchstart',touchStart,!1);myCanvas.addEventListener('touchmove',touchMove,!1);myCanvas.addEventListener('touchend',touchEnd,!1);var rect={},drag=!1,isDraw=!1;var imgData;this.setImg=function(){imgData=ctx.getImageData(0,0,myCanvas.width,myCanvas.height);rect={startX:0,startY:0,w:myCanvas.width,h:myCanvas.height}}
this.getRect=function(){if(rect.w<0){rect.w=-rect.w;rect.startX-=rect.w}
if(rect.h<0){rect.h=-rect.h;rect.startY-=rect.h}
return rect}
this.setDraw=function(d){isDraw=d}
this.getImgData=function(){rect=this.getRect();console.log(rect);ctx.putImageData(imgData,0,0);var img=ctx.getImageData(rect.startX,rect.startY,rect.w,rect.h);drawRect("stroke");return img}
function mouseDown(e){if(isDraw){ctx.clearRect(0,0,myCanvas.width,myCanvas.height);ctx.putImageData(imgData,0,0);rect.startX=e.pageX-this.offsetLeft-10;rect.startY=e.pageY-this.offsetTop-10;ctx.moveTo(e.pageX-this.offsetX,e.pageY-this.offsetY)}
drag=!0}
function mouseUp(){drag=!1}
function mouseMove(e){if(isDraw&&drag){rect.w=(e.pageX-this.offsetLeft-10)-rect.startX;rect.h=(e.pageY-this.offsetTop-10)-rect.startY;ctx.clearRect(0,0,myCanvas.width,myCanvas.height);ctx.putImageData(imgData,0,0);drawRect("stroke")}}
function touchStart(e){var touch=e.targetTouches[0];if(isDraw){ctx.clearRect(0,0,myCanvas.width,myCanvas.height);ctx.putImageData(imgData,0,0);rect.startX=touch.pageX-this.offsetLeft-10;rect.startY=touch.pageY-this.offsetTop-10;ctx.moveTo(touch.pageX-this.offsetX,touch.pageY-this.offsetY);e.preventDefault()}
drag=!0}
function touchEnd(e){drag=!1}
function touchMove(e){var touch=e.targetTouches[0];if(isDraw&&drag){rect.w=(touch.pageX-this.offsetLeft-10)-rect.startX;rect.h=(touch.pageY-this.offsetTop-10)-rect.startY;ctx.clearRect(0,0,myCanvas.width,myCanvas.height);ctx.putImageData(imgData,0,0);drawRect("stroke")}}
function drawRect(style){ctx.fillStyle="#93fff638";ctx.strokeStyle='#0099cc';if(style==="fill"){ctx.fillRect(rect.startX,rect.startY,rect.w,rect.h)}
if(style==="stroke"){ctx.strokeRect(rect.startX,rect.startY,rect.w,rect.h)}}}
let startAndStopBtn=document.getElementById('startAndStop');let recognizeBtn=document.getElementById('Recognize');let screenshotsBtn=document.getElementById('Screenshots');let speakBtn=document.getElementById('Speak');let videoInput=document.getElementById('videoInput');let canvasOutput=document.getElementById('canvasOutput');let canvasContext=canvasOutput.getContext('2d');let streaming=!1,isRecognize=!1,isScreenshots=!1;let src,dst,cap;let utils=new Utils('errorMessage');window.addEventListener('load',eventWindowLoaded,!1);let canvasApp;function eventWindowLoaded(){canvasApp=new CanvasApp('canvasOutput')}
screenshotsBtn.addEventListener('click',()=>{if(isScreenshots){isScreenshots=!1;screenshotsBtn.innerText='Screenshots';canvasOutput.removeAttribute('class','cursor-crosshair')}else{isScreenshots=!0;screenshotsBtn.innerText='Continue';canvasOutput.setAttribute('class','cursor-crosshair');canvasApp.setImg()}
canvasApp.setDraw(isScreenshots)});recognizeBtn.addEventListener('click',()=>{try{document.getElementById('RecognizeDiv').style.display="block";let progressText=document.getElementById('ProgressText');let recognizeText=document.getElementById('recognizeText');let recognizeProgressBar=new Utils.ProgressBar("myBar");recognizeProgressBar.init();var imgData=canvasApp.getImgData();isRecognize=!0;var options={lang:document.getElementById("language").value,};console.log(options);recognizeText.innerHTML='';Tesseract.recognize(imgData,options).progress(function(message){progressText.innerHTML=message.status.capitalize();if(message.status=='recognizing text'){recognizeProgressBar.runTo(message.progress*100);if(message.progress==1){isRecognize=!1}}}).then(function(result){console.log('result is: ',result);progressText.innerHTML='';recognizeText.innerText=result.text})}catch(err){utils.printError(err)}});startAndStopBtn.addEventListener('click',()=>{if(!streaming){utils.clearError();utils.startCamera('qvga',onVideoStarted,'videoInput')}else{utils.stopCamera();onVideoStopped()}});function onVideoStarted(){streaming=!0;startAndStop.innerText='Stop';CameraRun();recognizeBtn.removeAttribute('disabled');screenshotsBtn.removeAttribute('disabled');isScreenshots=!1}
function onVideoStopped(){streaming=!1;startAndStop.innerText='Start';canvasContext.clearRect(0,0,canvasOutput.width,canvasOutput.height);recognizeBtn.setAttribute('disabled',null);screenshotsBtn.setAttribute('disabled',null);isScreenshots=!1;screenshotsBtn.innerText='Screenshots';canvasApp.setDraw(!1)}
function onOpenCvReady(){document.getElementById('status').innerHTML='Ready.';startAndStop.removeAttribute('disabled');initCode();setTimeout(showPage,1000)}
function showPage(){document.getElementById("loader").style.display="none";document.getElementById("myDiv").style.display="block";handleResize()}
function initCode(){cap=new cv.VideoCapture(videoInput);dst=new cv.Mat(videoInput.height,videoInput.width,cv.CV_8UC1);src=new cv.Mat(videoInput.height,videoInput.width,cv.CV_8UC4)}
var lowRange=new Utils.RangeSliders("LowRange");lowRange.init("LowRangeValue");var highRange=new Utils.RangeSliders("HighRange");highRange.init("HighRangeValue");const FPS=50;function CameraRun(){isRecognize=!1;function processVideo(){try{if(!streaming){src.delete();dst.delete();src=new cv.Mat(videoInput.height,videoInput.width,cv.CV_8UC4);dst=new cv.Mat(videoInput.height,videoInput.width,cv.CV_8UC1);return}
let begin=Date.now();if(!isRecognize&&!isScreenshots){Video2Image()}
let delay=1000/FPS-(Date.now()-begin);setTimeout(processVideo,delay)}catch(err){utils.printError(err)}};function Video2Image(){var selector=document.querySelector('input[name="radio"]:checked');if(selector){cap.read(src);switch(selector.value){case 'Color':dst=src.clone();break;case 'GrayScale':cv.cvtColor(src,dst,cv.COLOR_RGBA2GRAY);break;case 'BlackAndWhite':var lowValue=lowRange.getValue();var highValue=highRange.getValue();let low=new cv.Mat(src.rows,src.cols,src.type(),[lowValue,lowValue,lowValue,0]);let high=new cv.Mat(src.rows,src.cols,src.type(),[highValue,highValue,highValue,255]);cv.inRange(src,low,high,dst);low.delete();high.delete();break;default:break}}
let dsize=new cv.Size(canvasOutput.width,canvasOutput.height);cv.resize(dst,dst,dsize);utils.showImage('canvasOutput',dst);canvasApp.setImg()}
setTimeout(processVideo,0)}
window.addEventListener("resize",handleResize);function handleResize(){videoInput.style.display="block";var w=videoInput.clientWidth-videoInput.clientLeft;canvasOutput.width=w;canvasOutput.height=w*0.75;canvasContext.fillStyle="#666666";canvasContext.fillRect(0,0,canvasOutput.width,canvasOutput.height);videoInput.style.display="none"}
var speech=new Utils.SpeechSyn('voice');speech.loadVoices('en');window.speechSynthesis.onvoiceschanged=function(e){speech.loadVoices('en')};function selectLeng(){var language=document.getElementById("language");var speak={'eng':'en','chi_tra':'zh','chi_sim':'zh','jpn':'ja'};var lang=speak[language.value];speech.clearVoices();speech.loadVoices(lang)}
speakBtn.addEventListener('click',()=>{let recognizeText=document.getElementById('recognizeText');speech.speak(recognizeText.innerText)})